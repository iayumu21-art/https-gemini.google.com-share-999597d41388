<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã•ã„ã“ã‚ã‚¸ãƒ¼ã‚¯ã‚¨ã‚¹ãƒˆ âœ¨AI Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        body {
            font-family: 'DotGothic16', sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            margin: 0;
        }
        #app { height: 100vh; max-height: 100vh; }
        .battle-log { flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.8); min-height: 60px; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .dice {
            display: inline-block; width: 60px; height: 60px; line-height: 60px;
            text-align: center; background: white; color: black; border-radius: 8px;
            font-size: 32px; font-weight: bold;
        }
        .awakened { animation: aura-pulse 1.5s infinite ease-in-out; }
        @keyframes aura-pulse {
            0% { filter: drop-shadow(0 0 5px #fff); transform: scale(1); }
            50% { filter: drop-shadow(0 0 15px #00ffff); transform: scale(1.1); }
            100% { filter: drop-shadow(0 0 5px #fff); transform: scale(1); }
        }
        .cutin-active { animation: cutin-in 1.5s ease-in-out forwards; }
        @keyframes cutin-in {
            0% { transform: translateX(-100%) skewX(-20deg); opacity: 0; }
            20% { transform: translateX(0) skewX(-20deg); opacity: 1; }
            80% { transform: translateX(0) skewX(-20deg); opacity: 1; }
            100% { transform: translateX(100%) skewX(-20deg); opacity: 0; }
        }
        .text-glow { text-shadow: 0 0 10px rgba(255,255,255,0.8), 0 0 20px currentColor; }
        .confetti { position: absolute; width: 10px; height: 10px; z-index: 100; pointer-events: none; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
        
        /* Loading Spinner */
        .loading-dots:after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
    </style>
</head>
<body class="flex items-center justify-center">

    <div id="app" class="relative w-full max-w-md bg-gray-900 p-2 sm:p-4 rounded-none sm:rounded-xl shadow-2xl flex flex-col border-4 border-gray-700">
        
        <!-- Start Screen -->
        <div id="start-screen" class="flex-grow flex flex-col items-center justify-center overflow-y-auto">
            <h1 class="text-2xl font-bold mb-2 text-yellow-500 text-center text-glow">ã•ã„ã“ã‚ã‚¸ãƒ¼ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
            <p class="mb-4 text-[10px] text-blue-300">âœ¨ Gemini AI Powerd Edition âœ¨</p>
            
            <div class="grid grid-cols-2 gap-2 w-full mb-4 px-2">
                <button onclick="window.showDetails('ayumu')" class="bg-blue-900 p-3 rounded border-2 border-transparent hover:border-white transition text-white">
                    <div class="text-3xl mb-1">âš”ï¸</div>
                    <div class="text-[10px] font-bold">ã‚¢ãƒ¦ãƒ </div>
                </button>
                <button onclick="window.showDetails('hikaru')" class="bg-green-900 p-3 rounded border-2 border-transparent hover:border-white transition text-white">
                    <div class="text-3xl mb-1">ğŸ¥·</div>
                    <div class="text-[10px] font-bold">ãƒ’ã‚«ãƒ«</div>
                </button>
                <button onclick="window.showDetails('shunsuke')" class="bg-red-900 p-3 rounded border-2 border-transparent hover:border-white transition text-white">
                    <div class="text-3xl mb-1">ğŸ›¡ï¸</div>
                    <div class="text-[10px] font-bold">ã‚·ãƒ¥ãƒ³ã‚¹ã‚±</div>
                </button>
                <button onclick="window.showDetails('hiiro')" class="bg-purple-900 p-3 rounded border-2 border-transparent hover:border-white transition text-white">
                    <div class="text-3xl mb-1">ğŸ§™</div>
                    <div class="text-[10px] font-bold">ãƒ’ã‚¤ãƒ­</div>
                </button>
            </div>

            <div id="char-detail" class="hidden w-full bg-black p-3 border-2 border-yellow-500 rounded mb-2">
                <h2 id="detail-name" class="text-lg font-bold text-yellow-400"></h2>
                <div id="detail-stats" class="text-xs mb-2 text-gray-300"></div>
                <button onclick="window.startGame()" class="w-full bg-yellow-600 hover:bg-yellow-500 py-2 rounded font-bold text-white text-sm">å†’é™ºã«å‡ºã‚‹</button>
            </div>
        </div>

        <!-- Battle Screen -->
        <div id="battle-screen" class="hidden h-full flex flex-col relative overflow-hidden">
            <!-- AI Analysis Panel (Floating) -->
            <div id="ai-analysis" class="absolute top-2 left-2 right-2 bg-blue-900/40 border border-blue-500/50 rounded p-2 z-30 hidden backdrop-blur-sm">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-bold text-blue-300">âœ¨ AIè§£æä¸­</span>
                    <div id="ai-loading" class="loading-dots text-blue-300 hidden"></div>
                </div>
                <div id="ai-monster-desc" class="text-[9px] text-gray-100 leading-tight italic"></div>
            </div>

            <div id="flash-overlay" class="absolute inset-0 z-50 pointer-events-none"></div>

            <!-- Enemy Area -->
            <div class="relative flex flex-col h-44 bg-gray-800 rounded-t-lg border-b-2 border-gray-700 p-2 pt-14">
                <div class="w-full mb-auto">
                    <div class="flex justify-between text-xs text-white mb-1">
                        <span id="enemy-name" class="font-bold"></span>
                        <span id="enemy-hp-text"></span>
                    </div>
                    <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden border border-gray-600">
                        <div id="enemy-hp-bar" class="bg-red-500 h-full transition-all duration-300"></div>
                    </div>
                </div>
                <div class="flex items-center justify-center flex-grow">
                    <div id="enemy-sprite" class="text-7xl transition-all duration-500 drop-shadow-lg">ğŸ‘¾</div>
                </div>
            </div>

            <!-- Player Area -->
            <div class="p-2 bg-gray-900 border-x-2 border-gray-700 flex flex-col items-center">
                <div id="player-sprite-container" class="mb-1">
                    <div id="player-sprite" class="text-4xl"></div>
                </div>
                <div class="w-full px-2">
                    <div class="flex justify-between text-xs mb-1">
                        <span id="player-name" class="font-bold text-blue-400"></span>
                        <span id="player-hp-text"></span>
                    </div>
                    <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden border border-gray-600">
                        <div id="player-hp-bar" class="bg-green-500 h-full transition-all duration-300"></div>
                    </div>
                </div>
            </div>

            <div id="battle-log" class="battle-log p-2 text-[10px] border-2 border-gray-700 bg-black font-mono leading-tight"></div>

            <div id="action-panel" class="grid grid-cols-2 gap-1 p-2 bg-gray-800 rounded-b-lg border-t-2 border-gray-700">
                <button onclick="window.command('attack')" class="bg-gray-700 hover:bg-gray-600 py-2 rounded text-white font-bold text-sm">æ”»æ’ƒ</button>
                <button onclick="window.command('heal')" class="bg-emerald-700 hover:bg-emerald-600 py-2 rounded text-white font-bold text-sm">å›å¾©</button>
                <button id="skill-btn" onclick="window.command('skill')" class="bg-blue-700 hover:bg-blue-600 py-2 rounded col-span-2 text-white font-bold text-sm">ã‚¹ã‚­ãƒ« (MP 1)</button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden flex-grow flex flex-col items-center justify-center text-center p-4 overflow-y-auto">
            <h2 id="result-title" class="text-3xl font-bold mb-4 text-glow"></h2>
            
            <div id="ai-epic-story" class="w-full bg-black/60 border-2 border-blue-500 rounded-lg p-3 mb-4 hidden">
                <h3 class="text-blue-400 font-bold border-b border-blue-800 mb-2 pb-1 text-center">âœ¨ AIãŒç¶´ã‚‹è‹±é›„è­š âœ¨</h3>
                <div id="ai-story-content" class="text-[10px] text-gray-200 text-left leading-relaxed max-h-40 overflow-y-auto pr-1">
                    ç‰©èªã‚’ç”Ÿæˆä¸­<span class="loading-dots"></span>
                </div>
            </div>

            <div id="result-message" class="text-sm text-white mb-6"></div>
            
            <div class="flex flex-col gap-2 w-full px-8">
                <button id="next-btn" onclick="window.nextStage()" class="bg-yellow-600 hover:bg-yellow-500 py-3 rounded font-bold text-white text-sm">æ¬¡ã®ã‚¨ãƒªã‚¢ã¸</button>
                <button id="restart-btn" onclick="location.reload()" class="hidden bg-gray-600 hover:bg-gray-500 py-3 rounded font-bold text-white text-sm">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- Dice Overlay -->
        <div id="dice-overlay" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
            <div class="text-center p-6 bg-gray-900 rounded-2xl border-2 border-yellow-500 shadow-2xl">
                <div id="dice-anim" class="dice">?</div>
                <div id="dice-result-name" class="mt-4 text-xl font-bold text-yellow-400"></div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const apiKey = ""; // Runtime automatically provides this

            const CHARACTERS = {
                ayumu: { name: 'ã‚¢ãƒ¦ãƒ ', job: 'å‹‡è€…', icon: 'âš”ï¸', maxHp: 400, atk: 30, maxMp: 5 },
                hikaru: { name: 'ãƒ’ã‚«ãƒ«', job: 'å¿è€…', icon: 'ğŸ¥·', maxHp: 280, atk: 45, maxMp: 5 },
                shunsuke: { name: 'ã‚·ãƒ¥ãƒ³ã‚¹ã‚±', job: 'æˆ¦å£«', icon: 'ğŸ›¡ï¸', maxHp: 520, atk: 35, maxMp: 3 },
                hiiro: { name: 'ãƒ’ã‚¤ãƒ­', job: 'é­”æ³•ä½¿ã„', icon: 'ğŸ§™', maxHp: 330, atk: 20, maxMp: 10 }
            };

            const MONSTERS = [
                { name: 'ã‚¹ãƒ©ã‚¤ãƒ ', icon: 'ğŸ’§', hp: 80, atk: 18 },
                { name: 'ã‚´ãƒ–ãƒªãƒ³', icon: 'ğŸ‘º', hp: 140, atk: 28 },
                { name: 'ã‚ªãƒ¼ã‚¯', icon: 'ğŸ—', hp: 280, atk: 42 },
                { name: 'ãƒ‰ãƒ©ã‚´ãƒ³', icon: 'ğŸ²', hp: 600, atk: 65 }
            ];

            let player = null;
            let enemy = null;
            let stage = 0;
            let gameStats = { totalDamageDealt: 0, totalDamageTaken: 0, totalTurns: 0 };
            let isProcessing = false;

            // --- Gemini API Integration ---

            async function callGemini(prompt, systemPrompt) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                let delay = 1000;
                for (let i = 0; i < 5; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text || "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                    } catch (e) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
                return "AIã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            }

            async function analyzeMonster(monsterName, icon) {
                const aiPanel = document.getElementById('ai-analysis');
                const aiText = document.getElementById('ai-monster-desc');
                const loader = document.getElementById('ai-loading');
                
                aiPanel.classList.remove('hidden');
                aiText.innerText = "ç‰¹å¾´ã‚’è§£æä¸­...";
                loader.classList.remove('hidden');

                const systemPrompt = "ã‚ãªãŸã¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼RPGã®ç‰©çŸ¥ã‚Šãªæ¡ˆå†…äººã§ã™ã€‚æç¤ºã•ã‚ŒãŸãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®åå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã€ãã®ç”Ÿæ…‹ã‚„æˆ¦é—˜ã®ã‚³ãƒ„ï¼ˆå¼±ç‚¹ã®ãƒ’ãƒ³ãƒˆãªã©ï¼‰ã‚’2ã€œ3è¡Œã®æ—¥æœ¬èªã§ã€éå¸¸ã«çŸ­ã„æ–‡ç« ã§æ•™ãˆã¦ãã ã•ã„ã€‚";
                const userPrompt = `ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å: ${monsterName}, è¦‹ãŸç›®: ${icon}`;

                const result = await callGemini(userPrompt, systemPrompt);
                aiText.innerText = result;
                loader.classList.add('hidden');
            }

            async function generateEpicStory() {
                const storyPanel = document.getElementById('ai-epic-story');
                const content = document.getElementById('ai-story-content');
                storyPanel.classList.remove('hidden');
                
                const systemPrompt = "ã‚ãªãŸã¯åŸéŠè©©äººã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å†’é™ºã®çµ±è¨ˆæƒ…å ±ã‚’ã‚‚ã¨ã«ã€ãã®å‹‡å§¿ã‚’ç§°ãˆã‚‹çŸ­ã„è‹±é›„è­šï¼ˆ150å­—ç¨‹åº¦ï¼‰ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚åå‰ã€ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸ã€è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ã€ã‚¿ãƒ¼ãƒ³æ•°ã‚’å«ã‚ã€ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚";
                const userPrompt = `åå‰: ${player.name}, ã‚¸ãƒ§ãƒ–: ${player.job}, ç·ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸: ${gameStats.totalDamageDealt}, ç·è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸: ${gameStats.totalDamageTaken}, ç·ã‚¿ãƒ¼ãƒ³æ•°: ${gameStats.totalTurns}, çµæœ: å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢`;

                const result = await callGemini(userPrompt, systemPrompt);
                content.innerText = result;
            }

            // --- UI & Logic ---

            window.showDetails = function(key) {
                const c = CHARACTERS[key];
                document.getElementById('char-detail').classList.remove('hidden');
                document.getElementById('detail-name').innerText = c.name + " (" + c.job + ")";
                document.getElementById('detail-stats').innerText = `HP: ${c.maxHp} / ATK: ${c.atk} / MP: ${c.maxMp}`;
                player = { ...c, hp: c.maxHp, mp: c.maxMp };
            };

            window.startGame = function() {
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('battle-screen').classList.remove('hidden');
                document.getElementById('player-sprite').innerText = player.icon;
                initStage();
            };

            function initStage() {
                const m = MONSTERS[stage];
                enemy = { ...m, maxHp: m.hp, hp: m.hp };
                updateUI();
                log(`ã‚¨ãƒªã‚¢${stage + 1}: ${enemy.name}ãŒç¾ã‚ŒãŸï¼`);
                analyzeMonster(enemy.name, enemy.icon);
            }

            function log(msg) {
                const div = document.createElement('div');
                div.innerText = "> " + msg;
                const box = document.getElementById('battle-log');
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }

            function updateUI() {
                document.getElementById('player-name').innerText = player.name;
                document.getElementById('player-hp-text').innerText = `${Math.ceil(player.hp)}/${player.maxHp}`;
                document.getElementById('player-hp-bar').style.width = `${(player.hp / player.maxHp) * 100}%`;
                
                document.getElementById('enemy-name').innerText = enemy.name;
                document.getElementById('enemy-sprite').innerText = enemy.icon;
                document.getElementById('enemy-hp-text').innerText = `${Math.ceil(enemy.hp)}/${enemy.maxHp}`;
                document.getElementById('enemy-hp-bar').style.width = `${(enemy.hp / enemy.maxHp) * 100}%`;
                
                document.getElementById('skill-btn').disabled = player.mp < 1;
            }

            window.command = async function(type) {
                if (isProcessing) return;
                isProcessing = true;
                gameStats.totalTurns++;

                if (type === 'attack') {
                    const dmg = Math.floor(player.atk * (0.9 + Math.random() * 0.4));
                    enemy.hp -= dmg;
                    gameStats.totalDamageDealt += dmg;
                    log(`${player.name}ã®æ”»æ’ƒï¼ ${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                    shake('enemy-sprite');
                } else if (type === 'heal') {
                    const heal = Math.floor(player.maxHp * 0.4);
                    player.hp = Math.min(player.maxHp, player.hp + heal);
                    log(`${player.name}ã¯å›å¾©ã—ãŸï¼ HPãŒ${heal}å›å¾©ï¼`);
                } else if (type === 'skill') {
                    player.mp--;
                    await rollDice();
                }

                updateUI();
                if (enemy.hp <= 0) {
                    await new Promise(r => setTimeout(r, 600));
                    showResult(true);
                    isProcessing = false;
                    return;
                }

                await new Promise(r => setTimeout(r, 600));
                
                // Enemy turn
                const eDmg = Math.floor(enemy.atk * (0.8 + Math.random() * 0.4));
                player.hp -= eDmg;
                gameStats.totalDamageTaken += eDmg;
                log(`${enemy.name}ã®æ”»æ’ƒï¼ ${eDmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                shake('player-sprite-container');

                updateUI();
                if (player.hp <= 0) {
                    showResult(false);
                }
                isProcessing = false;
            };

            async function rollDice() {
                const overlay = document.getElementById('dice-overlay');
                overlay.classList.remove('hidden');
                for(let i=0; i<8; i++) {
                    document.getElementById('dice-anim').innerText = Math.floor(Math.random()*6)+1;
                    await new Promise(r => setTimeout(r, 60));
                }
                let roll = Math.floor(Math.random() * 6) + 1;
                document.getElementById('dice-anim').innerText = roll;
                
                // Simplified skills for AI logic testing
                let dmg = player.atk * (roll === 1 ? 4 : 1.5);
                if (roll === 5 && player.name === 'ãƒ’ã‚¤ãƒ­') {
                    const selfDmg = Math.floor(player.maxHp * 0.25);
                    player.hp -= selfDmg;
                    log(`æš´èµ°ï¼ è‡ªåˆ†ã«${selfDmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                    dmg = 0;
                } else {
                    enemy.hp -= Math.floor(dmg);
                    gameStats.totalDamageDealt += Math.floor(dmg);
                    log(`ã‚¹ã‚­ãƒ«ç™ºå‹•ï¼ æ•µã«${Math.floor(dmg)}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                }
                
                document.getElementById('dice-result-name').innerText = "å‡ºç›®: " + roll;
                await new Promise(r => setTimeout(r, 800));
                overlay.classList.add('hidden');
            }

            function shake(id) {
                const el = document.getElementById(id);
                el.classList.add('shake');
                setTimeout(() => el.classList.remove('shake'), 500);
            }

            function showResult(victory) {
                document.getElementById('battle-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                const title = document.getElementById('result-title');
                const msg = document.getElementById('result-message');
                const next = document.getElementById('next-btn');
                const restart = document.getElementById('restart-btn');

                if (victory) {
                    title.innerText = "VICTORY";
                    msg.innerText = `${enemy.name}ã‚’å€’ã—ãŸï¼`;
                    if (stage >= MONSTERS.length - 1) {
                        title.innerText = "ALL CLEAR!";
                        msg.innerText = "ä¸–ç•Œã®å¹³å’ŒãŒå®ˆã‚‰ã‚ŒãŸï¼";
                        next.classList.add('hidden');
                        restart.classList.remove('hidden');
                        generateEpicStory(); // Gemini Power!
                    }
                } else {
                    title.innerText = "GAME OVER";
                    msg.innerText = "å†’é™ºã¯ã“ã“ã§çµ‚ã‚ã£ãŸ...";
                    next.classList.add('hidden');
                    restart.classList.remove('hidden');
                }
            }

            window.nextStage = function() {
                stage++;
                document.getElementById('result-screen').classList.add('hidden');
                document.getElementById('battle-screen').classList.remove('hidden');
                initStage();
            };

            function createConfetti() {
                for(let i=0; i<30; i++) {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                    c.style.animationDuration = (Math.random() * 2 + 1) + 's';
                    document.body.appendChild(c);
                }
            }
        })();
    </script>
</body>
</html>
